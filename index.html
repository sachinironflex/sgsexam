
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GD ExamCracker ‚Äì Daily Mock Test</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.5s ease;
        }

        .neon-black {
            background-color: #000000;
        }

        .neon-glow {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #007bff, 0 0 20px #007bff, 0 0 25px #007bff, 0 0 30px #007bff, 0 0 35px #007bff;
            animation: neon-glow 1.5s ease-in-out infinite alternate;
        }

        @keyframes neon-glow {
            from {
                text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #007bff, 0 0 20px #007bff;
            }
            to {
                text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #007bff, 0 0 40px #007bff, 0 0 50px #007bff;
            }
        }

        .drawer {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }

        .drawer.open {
            transform: translateX(0);
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .subject-button-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        @media (max-width: 640px) {
            .subject-button-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>

<!-- Main App Container -->
<div id="app" class="relative min-h-screen bg-gray-100 flex flex-col items-center"></div>

<!-- Custom Modal Container -->
<div id="modal-container" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay"></div>

<!-- Firebase CDN Imports -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
    // Global variable setup for Firebase context
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Admin Credentials
    const ADMIN_ID = "Sachin";
    const ADMIN_PASSWORD = "802165";

    // Application State Management
    const appState = {
        currentPage: 'splash',
        user: null,
        userProfile: null,
        isAdmin: false,
        activeSubject: null,
        activeTestNumber: null,
        currentQuestionIndex: 0,
        userAnswers: {},
        questions: [],
        userProgress: {},
        drawerOpen: false,
        modal: {
            isOpen: false,
            title: '',
            message: '',
            buttons: []
        }
    };

    // Firebase Initialization
    let app, auth, db, rtdb;
    try {
        app = firebase.initializeApp(firebaseConfig);
        auth = app.auth();
        db = app.firestore(); // For user progress
        rtdb = app.database(); // For public questions
    } catch (error) {
        console.error("Firebase Initialization Error: ", error);
    }
    
    // Auth State Listener
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            appState.user = user;
            appState.userProfile = {
                displayName: user.displayName || user.email,
                photoURL: user.photoURL || `https://placehold.co/100x100/A0AEC0/ffffff?text=${user.email.charAt(0).toUpperCase()}`
            };
            if (appState.currentPage === 'login') {
                if (user.email === ADMIN_ID && user.uid) { // Admin ID is an email, not just 'Sachin'
                    appState.isAdmin = true;
                    appState.currentPage = 'admin';
                } else {
                    appState.isAdmin = false;
                    appState.currentPage = 'main';
                }
            }
            if (appState.currentPage !== 'splash') {
                await fetchUserProgress();
            }
        } else {
            appState.user = null;
            appState.userProfile = null;
            appState.isAdmin = false;
            if (appState.currentPage !== 'splash') {
                appState.currentPage = 'login';
            }
        }
        renderApp();
    });

    // Custom Modal Function
    function showModal(title, message, buttons) {
        appState.modal = { isOpen: true, title, message, buttons };
        renderModal();
    }

    function hideModal() {
        appState.modal = { isOpen: false, title: '', message: '', buttons: [] };
        renderModal();
    }

    // Render Modal
    function renderModal() {
        const modalContainer = document.getElementById('modal-container');
        if (appState.modal.isOpen) {
            modalContainer.classList.remove('hidden');
            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">${appState.modal.title}</h3>
                    <p class="text-gray-700 text-center mb-6">${appState.modal.message}</p>
                    <div class="flex justify-center space-x-4">
                        ${appState.modal.buttons.map(btn => `
                            <button id="modal-btn-${btn.id}" class="px-6 py-2 rounded-lg font-semibold shadow-md transition-transform transform hover:scale-105 ${btn.class}">${btn.text}</button>
                        `).join('')}
                    </div>
                </div>
            `;
            appState.modal.buttons.forEach(btn => {
                document.getElementById(`modal-btn-${btn.id}`).onclick = () => {
                    hideModal();
                    if (btn.action) btn.action();
                };
            });
        } else {
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
        }
    }

    // --- Firebase Logic for User Progress (Firestore) ---
    async function fetchUserProgress() {
        if (!appState.user) return;
        try {
            const userProgressRef = db.collection(`artifacts/${appId}/users/${appState.user.uid}/userProgress`).doc('main');
            const doc = await userProgressRef.get();
            if (doc.exists) {
                appState.userProgress = doc.data();
            } else {
                appState.userProgress = {};
            }
        } catch (error) {
            console.error("Error fetching user progress:", error);
        }
    }

    async function updateUserProgress(subject, testNumber) {
        if (!appState.user) return;
        const userProgressRef = db.collection(`artifacts/${appId}/users/${appState.user.uid}/userProgress`).doc('main');
        const progressData = { ...appState.userProgress, [subject]: testNumber };
        try {
            await userProgressRef.set(progressData, { merge: true });
            appState.userProgress = progressData;
        } catch (error) {
            console.error("Error updating user progress:", error);
        }
    }

    // --- Navigation and Rendering ---
    function navigateTo(page, params = {}) {
        appState.currentPage = page;
        Object.keys(params).forEach(key => appState[key] = params[key]);
        renderApp();
    }

    function renderApp() {
        const appContainer = document.getElementById('app');
        appContainer.innerHTML = '';
        document.body.className = '';
        
        switch (appState.currentPage) {
            case 'splash':
                renderSplashScreen();
                break;
            case 'login':
                document.body.classList.add('bg-blue-900', 'bg-opacity-50', 'bg-gray-900');
                renderLoginPage();
                break;
            case 'main':
                document.body.classList.add('bg-gray-100');
                renderMainPage();
                break;
            case 'admin':
                document.body.classList.add('bg-gray-100');
                renderAdminPanel();
                break;
            case 'subject':
                document.body.classList.add('bg-gray-100');
                renderSubjectPage();
                break;
            case 'quiz':
                document.body.classList.add('bg-gray-100');
                renderQuizPage();
                break;
            case 'results':
                document.body.classList.add('bg-gray-100');
                renderResultsPage();
                break;
            default:
                renderSplashScreen();
                break;
        }
    }
    
    // --- Splash Screen ---
    function renderSplashScreen() {
        const appContainer = document.getElementById('app');
        document.body.classList.add('bg-blue-800', 'flex', 'items-center', 'justify-center');
        appContainer.innerHTML = `
            <div class="text-center animate-pulse">
                <div class="w-24 h-24 rounded-full bg-white flex items-center justify-center mx-auto mb-4 shadow-xl">
                    <i class="fa-solid fa-graduation-cap text-5xl text-blue-800"></i>
                </div>
                <h1 class="text-white text-3xl md:text-5xl font-bold tracking-wide">GD ExamCracker</h1>
                <p class="text-white text-lg md:text-xl font-medium mt-2">Daily Mock Test</p>
            </div>
        `;
        setTimeout(() => {
            if (!appState.user) {
                navigateTo('login');
            } else {
                navigateTo('main');
            }
        }, 2000);
    }
    
    // --- Login Page ---
    function renderLoginPage() {
        const appContainer = document.getElementById('app');
        appContainer.innerHTML = `
            <div class="bg-white p-8 md:p-12 rounded-2xl shadow-2xl w-full max-w-md mx-4 mt-16 transition-all duration-500 ease-in-out transform scale-95 opacity-0 animate-fade-in-up">
                <h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">Login</h2>
                <div class="mb-4">
                    <input id="email-input" type="email" placeholder="Email" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                </div>
                <div class="mb-6">
                    <input id="password-input" type="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                </div>
                <button id="login-email-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors duration-200 mb-4 shadow-lg">Login</button>
                <div class="flex justify-between text-sm mb-6">
                    <a href="#" id="forgot-password-link" class="text-blue-600 hover:underline">Forgot Password?</a>
                    <a href="#" id="signup-link" class="text-blue-600 hover:underline">Signup</a>
                </div>

                <div class="flex items-center my-6">
                    <hr class="flex-grow border-t border-gray-300">
                    <span class="mx-4 text-gray-500">OR</span>
                    <hr class="flex-grow border-t border-gray-300">
                </div>

                <button id="login-google-btn" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition-colors duration-200 mb-4 shadow-lg flex items-center justify-center">
                    <i class="fab fa-google mr-2 text-xl"></i> Login with Google
                </button>
                <button id="admin-login-btn" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-gray-900 transition-colors duration-200 shadow-lg">Admin Login</button>
            </div>
        `;
        
        // Add event listeners
        document.getElementById('login-email-btn').addEventListener('click', handleEmailLogin);
        document.getElementById('login-google-btn').addEventListener('click', handleGoogleLogin);
        document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
        document.getElementById('signup-link').addEventListener('click', handleSignup);
        document.getElementById('forgot-password-link').addEventListener('click', handleForgotPassword);
        
        // Trigger fade-in animation
        setTimeout(() => {
            document.querySelector('.animate-fade-in-up').classList.remove('scale-95', 'opacity-0');
        }, 100);
    }
    
    // Login handlers
    async function handleEmailLogin() {
        const email = document.getElementById('email-input').value;
        const password = document.getElementById('password-input').value;
        if (!email || !password) {
            showModal('Error', 'Please enter both email and password.', [{ text: 'OK', id: 'ok', class: 'bg-blue-500 text-white' }]);
            return;
        }
        try {
            await auth.signInWithEmailAndPassword(email, password);
            navigateTo('main');
        } catch (error) {
            showModal('Login Failed', error.message, [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white' }]);
        }
    }

    async function handleGoogleLogin() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            await auth.signInWithPopup(provider);
            navigateTo('main');
        } catch (error) {
            showModal('Login Failed', error.message, [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white' }]);
        }
    }

    function handleAdminLogin() {
        const email = document.getElementById('email-input').value;
        const password = document.getElementById('password-input').value;
        if (email === ADMIN_ID && password === ADMIN_PASSWORD) {
            auth.signInAnonymously().then(() => {
                appState.isAdmin = true;
                navigateTo('admin');
            }).catch(error => {
                showModal('Admin Login Failed', error.message, [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white' }]);
            });
        } else {
            showModal('Admin Login Failed', 'Invalid Admin ID or Password.', [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white' }]);
        }
    }

    function handleSignup() {
        const email = document.getElementById('email-input').value;
        const password = document.getElementById('password-input').value;
        if (!email || !password) {
            showModal('Error', 'Please enter a valid email and password for signup.', [{ text: 'OK', id: 'ok', class: 'bg-blue-500 text-white' }]);
            return;
        }
        auth.createUserWithEmailAndPassword(email, password)
            .then(() => {
                showModal('Success', 'Account created! Please log in.', [{ text: 'OK', id: 'ok', class: 'bg-green-500 text-white' }]);
            })
            .catch(error => {
                showModal('Signup Failed', error.message, [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white' }]);
            });
    }

    function handleForgotPassword() {
        const email = document.getElementById('email-input').value;
        if (!email) {
            showModal('Error', 'Please enter your email to reset the password.', [{ text: 'OK', id: 'ok', class: 'bg-blue-500 text-white' }]);
            return;
        }
        auth.sendPasswordResetEmail(email)
            .then(() => {
                showModal('Password Reset', 'A password reset link has been sent to your email.', [{ text: 'OK', id: 'ok', class: 'bg-green-500 text-white' }]);
            })
            .catch(error => {
                showModal('Password Reset Failed', error.message, [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white' }]);
            });
    }

    // --- Admin Panel ---
    function renderAdminPanel() {
        const appContainer = document.getElementById('app');
        appContainer.innerHTML = `
            <div class="flex w-full h-screen">
                <!-- Drawer -->
                <div id="drawer" class="drawer bg-gray-800 text-white w-64 p-4 space-y-4 fixed inset-y-0 left-0 z-40 shadow-xl overflow-y-auto">
                    <h3 class="text-xl font-bold mb-6">Admin Panel</h3>
                    <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showAdminSection('add-question')">Add Question</button>
                    <div class="border-t border-gray-700 my-4"></div>
                    <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showAdminSection('about-content')">About Content</button>
                    <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showAdminSection('privacy-content')">Privacy Policy Content</button>
                    <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="handleLogout()">Logout</button>
                </div>

                <!-- Main Content Area -->
                <div class="flex-grow ml-0 md:ml-64 p-6 transition-all duration-300 ease-in-out">
                    <!-- Top Bar -->
                    <div class="flex justify-between items-center mb-6">
                        <button id="toggle-drawer" class="text-gray-700 md:hidden"><i class="fas fa-bars text-2xl"></i></button>
                        <h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2>
                        <div></div>
                    </div>
                    <!-- Dynamic Section -->
                    <div id="admin-content" class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl text-gray-600">Please select an option from the drawer.</h3>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('toggle-drawer').addEventListener('click', () => {
            document.getElementById('drawer').classList.toggle('open');
        });
    }

    // Admin section renderer
    function showAdminSection(section) {
        const contentDiv = document.getElementById('admin-content');
        const subjects = ["Hindi", "Reasoning", "Maths", "Current Affairs", "GK", "Science", "Geography", "Policy", "History", "Previous Year", "Bihar GK"];

        let html = '';
        if (section === 'add-question') {
            html = `
                <h3 class="text-2xl font-bold mb-4">Add New Question</h3>
                <div class="mb-4">
                    <label for="subject-select" class="block text-gray-700 font-semibold mb-2">Select Subject:</label>
                    <select id="subject-select" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <div class="mb-4">
                    <label for="question-text" class="block text-gray-700 font-semibold mb-2">Question Text:</label>
                    <textarea id="question-text" rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-4 mb-4">
                    <div>
                        <label for="option-A" class="block text-gray-700">Option A:</label>
                        <input id="option-A" type="text" class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    </div>
                    <div>
                        <label for="option-B" class="block text-gray-700">Option B:</label>
                        <input id="option-B" type="text" class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    </div>
                    <div>
                        <label for="option-C" class="block text-gray-700">Option C:</label>
                        <input id="option-C" type="text" class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    </div>
                    <div>
                        <label for="option-D" class="block text-gray-700">Option D:</label>
                        <input id="option-D" type="text" class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Correct Answer:</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center"><input type="radio" name="correct-answer" value="A" class="form-radio text-blue-500"> <span class="ml-2">A</span></label>
                        <label class="flex items-center"><input type="radio" name="correct-answer" value="B" class="form-radio text-blue-500"> <span class="ml-2">B</span></label>
                        <label class="flex items-center"><input type="radio" name="correct-answer" value="C" class="form-radio text-blue-500"> <span class="ml-2">C</span></label>
                        <label class="flex items-center"><input type="radio" name="correct-answer" value="D" class="form-radio text-blue-500"> <span class="ml-2">D</span></label>
                    </div>
                </div>
                <button id="save-question-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition-colors duration-200 shadow-md">Save Question</button>
            `;
        } else if (section === 'about-content' || section === 'privacy-content') {
            html = `
                <h3 class="text-2xl font-bold mb-4">Edit ${section.replace('-content', '')}</h3>
                <textarea id="content-text" rows="10" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"></textarea>
                <button id="save-content-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors duration-200 shadow-md">Save Content</button>
            `;
        }
        contentDiv.innerHTML = html;

        if (section === 'add-question') {
            document.getElementById('save-question-btn').addEventListener('click', handleSaveQuestion);
        } else if (section === 'about-content' || section === 'privacy-content') {
            document.getElementById('save-content-btn').addEventListener('click', () => handleSaveContent(section));
            // Placeholder: Fetch existing content from a new RTDB path if it exists
        }
    }
    
    // --- Admin Functionality ---
    async function handleSaveQuestion() {
        const subject = document.getElementById('subject-select').value;
        const questionText = document.getElementById('question-text').value;
        const optionA = document.getElementById('option-A').value;
        const optionB = document.getElementById('option-B').value;
        const optionC = document.getElementById('option-C').value;
        const optionD = document.getElementById('option-D').value;
        const correctAnswer = document.querySelector('input[name="correct-answer"]:checked')?.value;

        if (!subject || !questionText || !optionA || !optionB || !optionC || !optionD || !correctAnswer) {
            showModal('Error', 'Please fill all fields.', [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white' }]);
            return;
        }

        const questionData = {
            question: questionText,
            optionA: optionA,
            optionB: optionB,
            optionC: optionC,
            optionD: optionD,
            answer: correctAnswer
        };

        const dbRef = rtdb.ref(`quiz/${subject}/test1`); // Using 'test1' as a placeholder testNumber. Admin should ideally select this.
        try {
            await dbRef.push(questionData);
            showModal('Success', 'Question saved successfully!', [{ text: 'OK', id: 'ok', class: 'bg-green-500 text-white' }]);
            // Clear form
            document.getElementById('question-text').value = '';
            document.getElementById('option-A').value = '';
            document.getElementById('option-B').value = '';
            document.getElementById('option-C').value = '';
            document.getElementById('option-D').value = '';
            document.querySelector('input[name="correct-answer"]:checked').checked = false;
        } catch (error) {
            showModal('Error', 'Failed to save question: ' + error.message, [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white' }]);
        }
    }
    
    // --- Main Page (User) ---
    function renderMainPage() {
        const appContainer = document.getElementById('app');
        const subjects = [
            { name: "Hindi", emoji: "üáÆüá≥" }, { name: "Reasoning", emoji: "üß†" },
            { name: "Maths", emoji: "üßÆ" }, { name: "Current Affairs", emoji: "üì∞" },
            { name: "GK", emoji: "üåç" }, { name: "Science", emoji: "üî¨" },
            { name: "Geography", emoji: "üó∫Ô∏è" }, { name: "Policy", emoji: "üèõÔ∏è" },
            { name: "History", emoji: "üìú" }, { name: "Previous Year", emoji: "üìñ" },
            { name: "Bihar GK", emoji: "üè∞" }
        ];

        appContainer.innerHTML = `
            <!-- Top Header -->
            <header class="w-full bg-black text-white p-4 flex items-center justify-between shadow-lg fixed top-0 z-30">
                <button id="toggle-drawer" class="text-xl px-2 py-1 rounded-full hover:bg-gray-800 transition-colors duration-200"><i class="fas fa-bars"></i></button>
                <h1 class="text-2xl font-extrabold neon-glow">GD ExamCracker</h1>
                <div class="user-profile-container flex items-center space-x-2">
                    <span class="text-sm hidden sm:inline">${appState.userProfile.displayName}</span>
                    <img src="${appState.userProfile.photoURL}" alt="User Photo" class="w-10 h-10 rounded-full border-2 border-white shadow-md">
                </div>
            </header>

            <!-- Drawer Menu -->
            <div id="drawer" class="drawer bg-gray-800 text-white w-64 p-4 space-y-4 fixed inset-y-0 left-0 z-40 shadow-xl overflow-y-auto">
                <div class="text-center py-4">
                    <img src="${appState.userProfile.photoURL}" alt="User Photo" class="w-20 h-20 rounded-full mx-auto mb-2 border-2 border-white shadow-md">
                    <p class="text-lg font-bold">${appState.userProfile.displayName}</p>
                </div>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showContentPage('About', 'About Page Content...')">About</button>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showContentPage('Privacy Policy', 'Privacy Policy Content...')">Privacy Policy</button>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showContentPage('Terms & Conditions', 'Terms & Conditions Content...')">Terms & Conditions</button>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showContentPage('Disclaimer', 'Disclaimer Content...')">Disclaimer</button>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="shareApp()">Share App</button>
                <button id="logout-btn" class="w-full text-left py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 transition-colors duration-200 mt-auto shadow-md">Logout</button>
            </div>

            <!-- Main Content Area -->
            <main class="flex-grow w-full p-4 mt-20 md:p-6 transition-all duration-300 ease-in-out">
                <div class="grid subject-button-grid gap-4 max-w-4xl mx-auto">
                    ${subjects.map(s => `
                        <button class="bg-white p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center space-y-2 transform transition-transform hover:scale-105" onclick="navigateToSubject('${s.name}')">
                            <span class="text-4xl">${s.emoji}</span>
                            <span class="font-semibold text-gray-800">${s.name}</span>
                        </button>
                    `).join('')}
                </div>
            </main>
        `;

        document.getElementById('toggle-drawer').addEventListener('click', () => {
            document.getElementById('drawer').classList.toggle('open');
        });
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
    }
    
    // Handle Logout
    function handleLogout() {
        auth.signOut().then(() => {
            navigateTo('login');
        }).catch(error => {
            showModal('Logout Failed', 'An error occurred during logout.', [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white' }]);
        });
    }

    // --- Subject Page ---
    function navigateToSubject(subjectName) {
        appState.activeSubject = subjectName;
        navigateTo('subject');
    }

    function renderSubjectPage() {
        const appContainer = document.getElementById('app');
        const completedTests = appState.userProgress[appState.activeSubject] || 0;
        const testButtons = Array.from({ length: 12 }, (_, i) => {
            const testNumber = i + 1;
            const isUnlocked = testNumber <= completedTests + 1;
            const isCompleted = testNumber <= completedTests;
            let statusText = '';
            let buttonClass = '';

            if (isCompleted) {
                statusText = 'Completed';
                buttonClass = 'bg-green-500 hover:bg-green-600';
            } else if (isUnlocked) {
                statusText = 'Unlocked';
                buttonClass = 'bg-blue-500 hover:bg-blue-600';
            } else {
                statusText = 'Locked';
                buttonClass = 'bg-gray-400 cursor-not-allowed';
            }
            
            return `
                <button class="w-full py-4 rounded-lg text-white font-bold shadow-md transition-transform transform hover:scale-105 ${buttonClass}" 
                        ${isUnlocked ? `onclick="startTest(${testNumber})"` : 'disabled'}>
                    Test ${testNumber}
                    <span class="block text-xs font-normal mt-1">${statusText}</span>
                </button>
            `;
        }).join('');

        appContainer.innerHTML = `
            <!-- Top Header -->
            <header class="w-full bg-black text-white p-4 flex items-center justify-between shadow-lg fixed top-0 z-30">
                <button onclick="navigateTo('main')" class="text-xl px-2 py-1 rounded-full hover:bg-gray-800 transition-colors duration-200"><i class="fas fa-arrow-left"></i></button>
                <h1 class="text-2xl font-extrabold neon-glow">${appState.activeSubject} Tests</h1>
                <div class="w-8"></div>
            </header>
            <div class="container mx-auto p-4 mt-20">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
                    ${testButtons}
                </div>
            </div>
        `;
    }

    // --- Quiz Logic ---
    async function startTest(testNumber) {
        appState.activeTestNumber = testNumber;
        appState.currentQuestionIndex = 0;
        appState.userAnswers = {};

        // Check for existing progress
        const testProgressKey = `${appState.activeSubject}-${testNumber}`;
        const storedProgress = JSON.parse(localStorage.getItem(testProgressKey));

        if (storedProgress && Object.keys(storedProgress.userAnswers).length > 0) {
            showModal(
                'Resume Test',
                'Would you like to continue the test from where you left off or restart?',
                [
                    { text: 'Continue', id: 'continue', class: 'bg-blue-500 text-white', action: () => {
                        appState.userAnswers = storedProgress.userAnswers;
                        appState.currentQuestionIndex = storedProgress.currentQuestionIndex;
                        fetchQuestions();
                    }},
                    { text: 'Restart', id: 'restart', class: 'bg-red-500 text-white', action: () => {
                        localStorage.removeItem(testProgressKey);
                        fetchQuestions();
                    }}
                ]
            );
        } else {
            fetchQuestions();
        }
    }

    async function fetchQuestions() {
        const loadingHtml = `<div class="flex items-center justify-center min-h-screen"><i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i></div>`;
        document.getElementById('app').innerHTML = loadingHtml;

        const subject = appState.activeSubject;
        const testNumber = appState.activeTestNumber;
        
        try {
            const dbRef = rtdb.ref(`quiz/${subject}/test${testNumber}`);
            const snapshot = await dbRef.once('value');
            const questionsObject = snapshot.val();
            if (questionsObject) {
                appState.questions = Object.values(questionsObject).slice(0, 20); // Get first 20 questions
                navigateTo('quiz');
            } else {
                showModal('Error', 'No questions found for this test. Please try another one.', [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white', action: () => navigateTo('subject') }]);
            }
        } catch (error) {
            console.error("Error fetching questions:", error);
            showModal('Error', 'Failed to load quiz. Please check your network and try again.', [{ text: 'OK', id: 'ok', class: 'bg-red-500 text-white', action: () => navigateTo('subject') }]);
        }
    }

    function renderQuizPage() {
        const appContainer = document.getElementById('app');
        const question = appState.questions[appState.currentQuestionIndex];
        if (!question) {
            return navigateTo('results');
        }

        const options = ['A', 'B', 'C', 'D'].map(key => ({
            key,
            text: question[`option${key}`]
        }));
        
        const currentAnswer = appState.userAnswers[appState.currentQuestionIndex];

        appContainer.innerHTML = `
            <!-- Top Header -->
            <header class="w-full bg-black text-white p-4 flex items-center justify-between shadow-lg fixed top-0 z-30">
                <button onclick="handleBackDuringQuiz()" class="text-xl px-2 py-1 rounded-full hover:bg-gray-800 transition-colors duration-200"><i class="fas fa-arrow-left"></i></button>
                <h1 class="text-2xl font-extrabold neon-glow">Quiz</h1>
                <div class="text-lg">Q. ${appState.currentQuestionIndex + 1}/${appState.questions.length}</div>
            </header>

            <div class="container mx-auto p-4 mt-20 max-w-2xl w-full">
                <div class="bg-white p-6 rounded-lg shadow-lg mb-4">
                    <p class="text-lg font-semibold text-gray-800">${question.question}</p>
                </div>
                <div class="space-y-4">
                    ${options.map(opt => `
                        <button id="option-${opt.key}" class="w-full text-left p-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105
                            ${currentAnswer === opt.key ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}
                        " onclick="handleAnswer('${opt.key}')">
                            <span class="font-bold mr-2">${opt.key}.</span> ${opt.text}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function handleBackDuringQuiz() {
        showModal(
            'Exit Quiz?',
            'Your progress will be saved. Do you want to exit the test?',
            [
                { text: 'Yes', id: 'yes', class: 'bg-red-500 text-white', action: () => {
                    saveQuizProgress();
                    navigateTo('subject');
                }},
                { text: 'No', id: 'no', class: 'bg-blue-500 text-white', action: () => {} }
            ]
        );
    }

    function saveQuizProgress() {
        const testProgressKey = `${appState.activeSubject}-${appState.activeTestNumber}`;
        const progress = {
            userAnswers: appState.userAnswers,
            currentQuestionIndex: appState.currentQuestionIndex
        };
        localStorage.setItem(testProgressKey, JSON.stringify(progress));
    }

    function handleAnswer(answer) {
        appState.userAnswers[appState.currentQuestionIndex] = answer;
        saveQuizProgress(); // Save progress after each answer
        setTimeout(() => {
            appState.currentQuestionIndex++;
            renderQuizPage();
        }, 500); // Small delay for visual feedback
    }

    // --- Results Page ---
    function renderResultsPage() {
        let correctCount = 0;
        let incorrectCount = 0;
        let answeredCount = 0;
        appState.questions.forEach((q, index) => {
            const userAnswer = appState.userAnswers[index];
            if (userAnswer) {
                answeredCount++;
                if (userAnswer === q.answer) {
                    correctCount++;
                } else {
                    incorrectCount++;
                }
            }
        });

        const appContainer = document.getElementById('app');
        appContainer.innerHTML = `
            <!-- Top Header -->
            <header class="w-full bg-black text-white p-4 flex items-center justify-between shadow-lg fixed top-0 z-30">
                <button onclick="navigateTo('subject')" class="text-xl px-2 py-1 rounded-full hover:bg-gray-800 transition-colors duration-200"><i class="fas fa-arrow-left"></i></button>
                <h1 class="text-2xl font-extrabold neon-glow">Test Results</h1>
                <div class="w-8"></div>
            </header>

            <div class="container mx-auto p-4 mt-20 max-w-2xl w-full">               <div class="bg-white p-6 rounded-lg shadow-lg text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Quiz Complete!</h2>
                    <p class="text-xl font-semibold text-gray-700">Your Score:</p>
                    <p class="text-5xl font-extrabold text-blue-600 my-4">${correctCount}/${appState.questions.length}</p>
                    <div class="flex justify-around text-center">
                        <div>
                            <p class="text-green-600 font-bold text-xl">${correctCount}</p>
                            <p class="text-gray-600">Correct</p>
                        </div>
                        <div>
                            <p class="text-red-600 font-bold text-xl">${incorrectCount}</p>
                            <p class="text-gray-600">Incorrect</p>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col space-y-4">
                    <button class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors duration-200 shadow-lg" onclick="viewAllQuestions()">View All Questions</button>
                    <button class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors duration-200 shadow-lg" onclick="reAttemptTest()">Re-Attempt Test</button>
                </div>
            </div>
        `;
        
        localStorage.removeItem(`${appState.activeSubject}-${appState.activeTestNumber}`);
        updateUserProgress(appState.activeSubject, appState.activeTestNumber);
    }
    
    // Results page actions
    function viewAllQuestions() {
        const appContainer = document.getElementById('app');
        const questionsHtml = appState.questions.map((q, index) => {
            const userAnswer = appState.userAnswers[index];
            const isCorrect = userAnswer === q.answer;
            const userStatus = isCorrect ? 'Correct' : 'Incorrect';
            const statusClass = isCorrect ? 'text-green-600' : 'text-red-600';

            return `
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <p class="font-semibold text-gray-800">Q. ${index + 1}: ${q.question}</p>
                    <ul class="list-disc list-inside mt-2 text-gray-700">
                        <li>A. ${q.optionA}</li>
                        <li>B. ${q.optionB}</li>
                        <li>C. ${q.optionC}</li>
                        <li>D. ${q.optionD}</li>
                    </ul>
                    <p class="mt-2 text-sm">
                        <span class="font-bold">Your Answer:</span> <span class="${userStatus === 'Correct' ? 'text-green-600' : 'text-red-600'}">${userAnswer} (${userStatus})</span>
                    </p>
                    <p class="mt-1 text-sm font-bold text-blue-600">Correct Answer: ${q.answer}</p>
                </div>
            `;
        }).join('');

        appContainer.innerHTML = `
            <!-- Top Header -->
            <header class="w-full bg-black text-white p-4 flex items-center justify-between shadow-lg fixed top-0 z-30">
                <button onclick="navigateTo('results')" class="text-xl px-2 py-1 rounded-full hover:bg-gray-800 transition-colors duration-200"><i class="fas fa-arrow-left"></i></button>
                <h1 class="text-2xl font-extrabold neon-glow">All Questions</h1>
                <div class="w-8"></div>
            </header>
            <div class="container mx-auto p-4 mt-20">
                ${questionsHtml}
            </div>
        `;
    }

    function reAttemptTest() {
        navigateTo('quiz', { currentQuestionIndex: 0, userAnswers: {} });
    }

    // --- Back Button and Share Logic ---
    window.onpopstate = () => {
        // Implement history-based navigation if needed
    };

    function shareApp() {
        if (navigator.share) {
            navigator.share({
                title: 'GD ExamCracker',
                text: 'Prepare for GD exams with GD ExamCracker!',
                url: window.location.href,
            }).then(() => {
                console.log('Thanks for sharing!');
            }).catch(console.error);
        } else {
            showModal('Share App', 'Please copy this link to share: ' + window.location.href, [{ text: 'OK', id: 'ok', class: 'bg-blue-500 text-white' }]);
        }
    }

    // Initial render
    window.onload = () => {
        renderApp();
    };

</script>
</body>
</html>
