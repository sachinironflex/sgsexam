<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GD ExamCracker – Daily Mock Test</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.5s ease;
        }

        .neon-black {
            background-color: #000000;
        }

        .neon-glow {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #007bff, 0 0 20px #007bff, 0 0 25px #007bff, 0 0 30px #007bff, 0 0 35px #007bff;
            animation: neon-glow 1.5s ease-in-out infinite alternate;
        }

        @keyframes neon-glow {
            from {
                text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #007bff, 0 0 20px #007bff;
            }
            to {
                text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #007bff, 0 0 40px #007bff, 0 0 50px #007bff;
            }
        }

        .drawer {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }

        .drawer.open {
            transform: translateX(0);
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .subject-button-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        @media (max-width: 640px) {
            .subject-button-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>

<!-- Main App Container -->
<div id="app" class="relative min-h-screen bg-gray-100 flex flex-col items-center"></div>

<!-- Custom Modal Container -->
<div id="modal-container" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay"></div>

<!-- Firebase CDN Imports -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
    // Firebase और ऐप स्थिति के लिए ग्लोबल वेरिएबल सेटअप
    let firebaseConfig = {
      apiKey: "AIzaSyB9thAZ6J72ovXU2CXBeeFIiKyj3McgwfI",
      authDomain: "ssc-gd-c174a.firebaseapp.com",
      databaseURL: "https://ssc-gd-c174a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ssc-gd-c174a",
      storageBucket: "ssc-gd-c174a.firebasestorage.app",
      messagingSenderId: "306957230185",
      appId: "1:306957230185:web:a32e27c4406eb7eb15c2f8"
    };

    const appId = firebaseConfig.appId;

    // एडमिन क्रेडेंशियल्स
    const ADMIN_ID = "Sachin";
    const ADMIN_EMAIL = "sachinkumarjii753@gmail.com";
    const ADMIN_PASSWORD = "Sachin@802165";

    // एप्लीकेशन स्टेट मैनेजमेंट
    const appState = {
        currentPage: 'splash',
        user: null,
        userProfile: null,
        isAdmin: false,
        activeSubject: null,
        activeTestNumber: null,
        currentQuestionIndex: 0,
        userAnswers: {},
        questions: [],
        userProgress: {},
        drawerOpen: false,
        modal: {
            isOpen: false,
            title: '',
            message: '',
            buttons: []
        }
    };

    // Firebase Initialization
    let app, auth, db, rtdb;
    try {
        app = firebase.initializeApp(firebaseConfig);
        auth = app.auth();
        db = app.firestore(); // Firestore user progress के लिए
        rtdb = app.database(); // Realtime Database प्रश्नों और कंटेंट के लिए
    } catch (error) {
        console.error("Firebase Initialization Error: ", error);
        showModal('त्रुटि', `Firebase को शुरू करने में त्रुटि। कृपया बाद में पुनः प्रयास करें।`, [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white' }]);
    }
    
    // Auth State Listener
    auth.onAuthStateChanged(async (user) => {
        appState.user = user;
        if (user) {
            appState.userProfile = {
                displayName: user.displayName || user.email || 'User',
                photoURL: user.photoURL || `https://placehold.co/100x100/A0AEC0/ffffff?text=${(user.email || 'U').charAt(0).toUpperCase()}`
            };
            if (user.email === ADMIN_EMAIL) {
                appState.isAdmin = true;
                console.log("Admin UID:", user.uid);
            } else {
                appState.isAdmin = false;
            }
            if (appState.currentPage === 'login' || appState.currentPage === 'admin') {
                if (appState.isAdmin) {
                    navigateTo('admin');
                } else {
                    navigateTo('main');
                }
            }
        } else {
            appState.user = null;
            appState.userProfile = null;
            appState.isAdmin = false;
            if (appState.currentPage !== 'splash') {
                navigateTo('login');
            }
        }
        await fetchUserProgress();
        renderApp();
    });

    // कस्टम मोडल फंक्शन
    function showModal(title, message, buttons, contentHtml = '') {
        appState.modal = { isOpen: true, title, message, buttons, contentHtml };
        renderModal();
    }

    function hideModal() {
        appState.modal = { isOpen: false, title: '', message: '', buttons: [] };
        renderModal();
    }

    // मोडल रेंडर करें
    function renderModal() {
        const modalContainer = document.getElementById('modal-container');
        if (appState.modal.isOpen) {
            modalContainer.classList.remove('hidden');
            let content = appState.modal.contentHtml || `<p class="text-gray-700 text-center mb-6">${appState.modal.message}</p>`;
            modalContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-center">${appState.modal.title}</h3>
                    ${content}
                    <div class="flex justify-center space-x-4 mt-6">
                        ${appState.modal.buttons.map(btn => `
                            <button id="modal-btn-${btn.id}" class="px-6 py-2 rounded-lg font-semibold shadow-md transition-transform transform hover:scale-105 ${btn.class}">${btn.text}</button>
                        `).join('')}
                    </div>
                </div>
            `;
            appState.modal.buttons.forEach(btn => {
                const modalBtn = document.getElementById(`modal-btn-${btn.id}`);
                if (modalBtn) {
                    modalBtn.onclick = () => {
                        hideModal();
                        if (btn.action) btn.action();
                    };
                }
            });
        } else {
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
        }
    }

    // --- फायरस्टोर से उपयोगकर्ता की प्रगति का तर्क (Firestore) ---
    async function fetchUserProgress() {
        if (!appState.user) return;
        try {
            const userId = auth.currentUser?.uid;
            if (!userId) return;
            // FIX: Check if we are online before trying to get document from Firestore
            if (navigator.onLine) {
                const userProgressRef = db.collection(`artifacts/${appId}/users/${userId}/userProgress`).doc('main');
                const doc = await userProgressRef.get();
                if (doc.exists) {
                    appState.userProgress = doc.data();
                } else {
                    appState.userProgress = {};
                }
            } else {
                console.error("उपयोगकर्ता की प्रगति लाने में त्रुटि: Client is offline.");
                appState.userProgress = {}; // Fallback to empty progress
            }
        } catch (error) {
            console.error("उपयोगकर्ता की प्रगति लाने में त्रुटि:", error);
        }
    }

    async function updateUserProgress(subject, testNumber) {
        if (!appState.user) return;
        const userId = auth.currentUser?.uid;
        if (!userId) return;
        if (!navigator.onLine) {
            console.error("उपयोगकर्ता की प्रगति को अपडेट करने में त्रुटि: Client is offline.");
            return;
        }
        const userProgressRef = db.collection(`artifacts/${appId}/users/${userId}/userProgress`).doc('main');
        const progressData = { ...appState.userProgress, [subject]: testNumber };
        try {
            await userProgressRef.set(progressData, { merge: true });
            appState.userProgress = progressData;
        } catch (error) {
            console.error("उपयोगकर्ता की प्रगति को अपडेट करने में त्रुटि:", error);
        }
    }
    
    // फायरस्टोर में क्विज की प्रगति को सेव करें
    async function saveQuizProgress() {
        if (!appState.user) return;
        const userId = auth.currentUser?.uid;
        if (!userId || !navigator.onLine) return;

        const quizProgressRef = db.collection(`artifacts/${appId}/users/${userId}/quizProgress`).doc(appState.activeSubject);
        const data = {
            subject: appState.activeSubject,
            testNumber: appState.activeTestNumber,
            currentQuestionIndex: appState.currentQuestionIndex,
            userAnswers: appState.userAnswers // Firestore में ऑब्जेक्ट स्टोर कर सकते हैं
        };

        try {
            await quizProgressRef.set(data);
        } catch (error) {
            console.error("क्विज की प्रगति को सेव करने में त्रुटि:", error);
        }
    }
    
    // फायरस्टोर से क्विज की प्रगति को लाएँ
    async function fetchQuizProgress() {
        if (!appState.user) return;
        const userId = auth.currentUser?.uid;
        if (!userId || !navigator.onLine) return;

        const quizProgressRef = db.collection(`artifacts/${appId}/users/${userId}/quizProgress`).doc(appState.activeSubject);
        try {
            const doc = await quizProgressRef.get();
            if (doc.exists && doc.data().testNumber === appState.activeTestNumber) {
                return doc.data();
            }
        } catch (error) {
            console.error("क्विज की प्रगति लाने में त्रुटि:", error);
        }
        return null;
    }

    // --- नेविगेशन और रेंडरिंग ---
    function navigateTo(page, params = {}) {
        appState.currentPage = page;
        Object.keys(params).forEach(key => appState[key] = params[key]);
        renderApp();
    }
    
    // बेस UI स्ट्रक्चर को एक बार रेंडर करें
    function renderBaseUI() {
        const appContainer = document.getElementById('app');
        appContainer.innerHTML = `
            <!-- टॉप हेडर -->
            <header id="app-header" class="w-full bg-black text-white p-4 flex items-center justify-between shadow-lg fixed top-0 z-30"></header>
            
            <!-- दराज मेनू -->
            <div id="drawer" class="drawer bg-gray-800 text-white w-64 p-4 space-y-4 fixed inset-y-0 left-0 z-40 shadow-xl overflow-y-auto"></div>

            <!-- मुख्य सामग्री क्षेत्र -->
            <main id="main-content" class="flex-grow w-full p-4 mt-20 md:p-6 transition-all duration-300 ease-in-out"></main>
        `;

        // Drawer ko band karne ka logic
        document.getElementById('app').addEventListener('click', (event) => {
            const drawer = document.getElementById('drawer');
            const toggleButton = document.getElementById('toggle-drawer');
            // Agar drawer khula hai aur click drawer ya toggle button ke bahar hua hai
            if (drawer && drawer.classList.contains('open') && !drawer.contains(event.target) && !toggleButton.contains(event.target)) {
                drawer.classList.remove('open');
            }
        });
    }

    function renderApp() {
        const appContainer = document.getElementById('app');
        appContainer.innerHTML = '';
        document.body.className = '';
        
        switch (appState.currentPage) {
            case 'splash':
                renderSplashScreen();
                break;
            case 'login':
                document.body.classList.add('bg-blue-900', 'bg-opacity-50', 'bg-gray-900');
                renderLoginPage();
                break;
            case 'main':
                document.body.classList.add('bg-gray-100');
                renderBaseUI(); // बेस UI रेंडर करें
                renderHeader();
                renderDrawer();
                renderMainPageContent(); // केवल कंटेंट रेंडर करें
                break;
            case 'admin':
                document.body.classList.add('bg-gray-100');
                renderBaseUI(); // बेस UI रेंडर करें
                renderHeader();
                renderDrawer(); // एडमिन के लिए भी drawer render karein
                renderAdminPanelContent(); // केवल कंटेंट रेंडर करें
                break;
            case 'subject':
                document.body.classList.add('bg-gray-100');
                renderBaseUI(); // बेस UI रेंडर करें
                renderHeader();
                renderDrawer();
                renderSubjectPageContent(); // केवल कंटेंट रेंडर करें
                break;
            case 'quiz':
                document.body.classList.add('bg-gray-100');
                renderBaseUI();
                renderQuizPageContent();
                break;
            case 'results':
                document.body.classList.add('bg-gray-100');
                renderBaseUI();
                renderResultsPageContent();
                break;
            default:
                renderSplashScreen();
                break;
        }
    }

    // नया फंक्शन: हेडर रेंडर करें
    function renderHeader() {
        const header = document.getElementById('app-header');
        if (!header) return;
        header.innerHTML = `
            <button id="toggle-drawer" class="text-xl px-2 py-1 rounded-full hover:bg-gray-800 transition-colors duration-200"><i class="fas fa-bars"></i></button>
            <h1 class="text-2xl font-extrabold neon-glow">GD ExamCracker</h1>
            <div class="user-profile-container flex items-center space-x-2">
                <span class="text-sm hidden sm:inline">${appState.userProfile.displayName}</span>
                <img src="${appState.userProfile.photoURL}" alt="User Photo" class="w-10 h-10 rounded-full border-2 border-white shadow-md">
            </div>
        `;
        document.getElementById('toggle-drawer').addEventListener('click', (event) => {
            const drawer = document.getElementById('drawer');
            if (drawer) {
                drawer.classList.toggle('open');
                event.stopPropagation(); // Drawer toggle button par click karne par drawer band na ho
            }
        });
    }

    // नया फंक्शन: दराज रेंडर करें
    function renderDrawer() {
        const drawer = document.getElementById('drawer');
        if (!drawer) return;
        let drawerButtons;
        if (appState.isAdmin) {
             drawerButtons = `
                <div class="text-center py-4">
                    <img src="${appState.userProfile.photoURL}" alt="User Photo" class="w-20 h-20 rounded-full mx-auto mb-2 border-2 border-white shadow-md">
                    <p class="text-lg font-bold">${appState.userProfile.displayName}</p>
                </div>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="navigateTo('main')">Home</button>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showAdminSection('add-question')">प्रश्न जोड़ें</button>
                <button class="w-full text-left py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 transition-colors duration-200 mt-auto shadow-md" onclick="handleLogout()">लॉगआउट</button>
             `;
        } else {
             drawerButtons = `
                <div class="text-center py-4">
                    <img src="${appState.userProfile.photoURL}" alt="User Photo" class="w-20 h-20 rounded-full mx-auto mb-2 border-2 border-white shadow-md">
                    <p class="text-lg font-bold">${appState.userProfile.displayName}</p>
                </div>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="navigateTo('main')">Home</button>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showContentPage('About', 'About Page Content...')">About</button>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showContentPage('Privacy Policy', 'Privacy Policy Content...')">Privacy Policy</button>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showContentPage('Terms & Conditions', 'Terms & Conditions Content...')">Terms & Conditions</button>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="showContentPage('Disclaimer', 'Disclaimer Content...')">Disclaimer</button>
                <button class="w-full text-left py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="shareApp()">Share App</button>
                <button id="logout-btn" class="w-full text-left py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 transition-colors duration-200 mt-auto shadow-md" onclick="handleLogout()">लॉगआउट</button>
             `;
        }
        drawer.innerHTML = drawerButtons;
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
    }

    // --- स्प्लैश स्क्रीन ---
    function renderSplashScreen() {
        const appContainer = document.getElementById('app');
        document.body.classList.add('bg-blue-800', 'flex', 'items-center', 'justify-center');
        appContainer.innerHTML = `
            <div class="text-center animate-pulse">
                <div class="w-24 h-24 rounded-full bg-white flex items-center justify-center mx-auto mb-4 shadow-xl">
                    <i class="fa-solid fa-graduation-cap text-5xl text-blue-800"></i>
                </div>
                <h1 class="text-white text-3xl md:text-5xl font-bold tracking-wide">GD ExamCracker</h1>
                <p class="text-white text-lg md:text-xl font-medium mt-2">Daily Mock Test</p>
            </div>
        `;
        setTimeout(() => {
            if (!appState.user) {
                navigateTo('login');
            } else {
                navigateTo('main');
            }
        }, 2000);
    }
    
    // --- लॉगिन पेज ---
    function renderLoginPage() {
        const appContainer = document.getElementById('app');
        appContainer.innerHTML = `
            <div class="bg-white p-8 md:p-12 rounded-2xl shadow-2xl w-full max-w-md mx-4 mt-16 transition-all duration-500 ease-in-out transform scale-95 opacity-0 animate-fade-in-up">
                <h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">Login</h2>
                <div class="mb-4">
                    <input id="email-input" type="email" placeholder="Email" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                </div>
                <div class="mb-6">
                    <input id="password-input" type="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                </div>
                <button id="login-email-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors duration-200 mb-4 shadow-lg">Login</button>
                <div class="flex justify-between text-sm mb-6">
                    <a href="#" id="forgot-password-link" class="text-blue-600 hover:underline">Forgot Password?</a>
                    <a href="#" id="signup-link" class="text-blue-600 hover:underline">Signup</a>
                </div>

                <div class="flex items-center my-6">
                    <hr class="flex-grow border-t border-gray-300">
                    <span class="mx-4 text-gray-500">OR</span>
                    <hr class="flex-grow border-t border-gray-300">
                </div>

                <button id="login-google-btn" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition-colors duration-200 mb-4 shadow-lg flex items-center justify-center">
                    <i class="fab fa-google mr-2 text-xl"></i> Login with Google
                </button>
                <button id="admin-login-btn" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-gray-900 transition-colors duration-200 shadow-lg">Admin Login</button>
            </div>
        `;
        
        // इवेंट लिसनर्स जोड़ें
        document.getElementById('login-email-btn').addEventListener('click', handleEmailLogin);
        document.getElementById('login-google-btn').addEventListener('click', handleGoogleLogin);
        document.getElementById('admin-login-btn').addEventListener('click', showAdminLoginModal);
        document.getElementById('signup-link').addEventListener('click', handleSignup);
        document.getElementById('forgot-password-link').addEventListener('click', handleForgotPassword);
        
        // फ़ेड-इन एनिमेशन ट्रिगर करें
        setTimeout(() => {
            document.querySelector('.animate-fade-in-up').classList.remove('scale-95', 'opacity-0');
        }, 100);
    }
    
    // लॉगिन हैंडलर्स
    async function handleEmailLogin() {
        const email = document.getElementById('email-input').value;
        const password = document.getElementById('password-input').value;
        if (!email || !password) {
            showModal('Error', 'कृपया ईमेल और पासवर्ड दोनों दर्ज करें।', [{ text: 'ठीक है', id: 'ok', class: 'bg-blue-500 text-white' }]);
            return;
        }
        try {
            await auth.signInWithEmailAndPassword(email, password);
            navigateTo('main');
        } catch (error) {
            showModal('लॉगिन विफल', 'लॉगिन विफल रहा: ' + error.message, [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white' }]);
        }
    }

    async function handleGoogleLogin() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            await auth.signInWithPopup(provider);
            navigateTo('main');
        } catch (error) {
            showModal('लॉगिन विफल', 'Google लॉगिन विफल रहा: ' + error.message, [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white' }]);
        }
    }
    
    // एडमिन लॉगिन मोडल दिखाएं
    function showAdminLoginModal() {
        const modalContent = `
            <div class="space-y-4">
                <div>
                    <input id="admin-id-input" type="text" placeholder="Admin ID" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                </div>
                <div>
                    <input id="admin-password-input" type="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                </div>
                <p id="admin-error-message" class="text-red-500 text-sm text-center hidden"></p>
            </div>
        `;
        showModal('Admin Login', '', [{
            text: 'Login',
            id: 'admin-login-confirm-btn',
            class: 'bg-green-600 text-white',
            action: checkAdminCredentials
        }, {
            text: 'Cancel',
            id: 'admin-login-cancel-btn',
            class: 'bg-gray-500 text-white',
            action: hideModal
        }], modalContent);
    }
    
    // एडमिन क्रेडेंशियल्स जांचें
    async function checkAdminCredentials() {
        const adminIdInput = document.getElementById('admin-id-input');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const errorMessageDiv = document.getElementById('admin-error-message');

        if (!adminIdInput || !adminPasswordInput || !errorMessageDiv) {
            return;
        }
        
        const adminId = adminIdInput.value;
        const adminPassword = adminPasswordInput.value;

        if (adminId === ADMIN_ID && adminPassword === ADMIN_PASSWORD) {
            try {
                await auth.signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PASSWORD);
                appState.isAdmin = true;
                hideModal();
                console.log("Admin UID:", auth.currentUser.uid);
                navigateTo('admin');
            } catch (error) {
                errorMessageDiv.textContent = 'लॉगिन विफल रहा: ' + error.message;
                errorMessageDiv.classList.remove('hidden');
            }
        } else {
            errorMessageDiv.textContent = 'अमान्य एडमिन आईडी या पासवर्ड।';
            errorMessageDiv.classList.remove('hidden');
        }
    }

    function handleSignup() {
        const email = document.getElementById('email-input').value;
        const password = document.getElementById('password-input').value;
        if (!email || !password) {
            showModal('Error', 'कृपया साइनअप के लिए एक वैध ईमेल और पासवर्ड दर्ज करें।', [{ text: 'ठीक है', id: 'ok', class: 'bg-blue-500 text-white' }]);
            return;
        }
        auth.createUserWithEmailAndPassword(email, password)
            .then(() => {
                showModal('सफलता', 'खाता बनाया गया! कृपया लॉग इन करें।', [{ text: 'ठीक है', id: 'ok', class: 'bg-green-500 text-white' }]);
            })
            .catch(error => {
                showModal('साइनअप विफल', 'साइनअप विफल रहा: ' + error.message, [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white' }]);
            });
    }

    function handleForgotPassword() {
        const email = document.getElementById('email-input').value;
        if (!email) {
            showModal('Error', 'पासवर्ड रीसेट करने के लिए कृपया अपना ईमेल दर्ज करें।', [{ text: 'ठीक है', id: 'ok', class: 'bg-blue-500 text-white' }]);
            return;
        }
        auth.sendPasswordResetEmail(email)
            .then(() => {
                showModal('पासवर्ड रीसेट', 'आपके ईमेल पर एक पासवर्ड रीसेट लिंक भेजा गया है।', [{ text: 'ठीक है', id: 'ok', class: 'bg-green-500 text-white' }]);
            })
            .catch(error => {
                showModal('पासवर्ड रीसेट विफल', 'पासवर्ड रीसेट विफल रहा: ' + error.message, [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white' }]);
            });
    }

    // --- एडमिन पैनल ---
    function renderAdminPanelContent() {
        const contentDiv = document.getElementById('main-content');
        if (!contentDiv) return;
        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">एडमिन डैशबोर्ड</h2>
                <div></div>
            </div>
            <div id="admin-content-section" class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl text-gray-600">कृपया दराज से एक विकल्प चुनें।</h3>
            </div>
        `;
        showAdminSection('add-question');
    }
    
    // एडमिन सेक्शन रेंडरर
    function showAdminSection(section) {
        const contentDiv = document.getElementById('admin-content-section');
        if (!contentDiv) return;
        const subjects = ["Hindi", "Reasoning", "Maths", "Current Affairs", "GK", "Science", "Geography", "Policy", "History", "Previous Year", "Bihar GK"];
        const testNumbers = Array.from({ length: 12 }, (_, i) => i + 1);

        let html = '';
        if (section === 'add-question') {
            html = `
                <h3 class="text-2xl font-bold mb-4">नया प्रश्न जोड़ें</h3>
                <div class="mb-4">
                    <label for="subject-select" class="block text-gray-700 font-semibold mb-2">विषय चुनें:</label>
                    <select id="subject-select" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <div class="mb-4">
                    <label for="test-select" class="block text-gray-700 font-semibold mb-2">टेस्ट नंबर चुनें:</label>
                    <select id="test-select" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        ${testNumbers.map(n => `<option value="test${n}">टेस्ट ${n}</option>`).join('')}
                    </select>
                </div>
                <div class="mb-4">
                    <label for="question-text" class="block text-gray-700 font-semibold mb-2">प्रश्न टेक्स्ट:</label>
                    <textarea id="question-text" rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-4 mb-4">
                    <div>
                        <label for="option-A" class="block text-gray-700">विकल्प A:</label>
                        <input id="option-A" type="text" class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    </div>
                    <div>
                        <label for="option-B" class="block text-gray-700">विकल्प B:</label>
                        <input id="option-B" type="text" class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    </div>
                    <div>
                        <label for="option-C" class="block text-gray-700">विकल्प C:</label>
                        <input id="option-C" type="text" class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    </div>
                    <div>
                        <label for="option-D" class="block text-gray-700">विकल्प D:</label>
                        <input id="option-D" type="text" class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">सही उत्तर:</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center"><input type="radio" name="correct-answer" value="A" class="form-radio text-blue-500"> <span class="ml-2">A</span></label>
                        <label class="flex items-center"><input type="radio" name="correct-answer" value="B" class="form-radio text-blue-500"> <span class="ml-2">B</span></label>
                        <label class="flex items-center"><input type="radio" name="correct-answer" value="C" class="form-radio text-blue-500"> <span class="ml-2">C</span></label>
                        <label class="flex items-center"><input type="radio" name="correct-answer" value="D" class="form-radio text-blue-500"> <span class="ml-2">D</span></label>
                    </div>
                </div>
                <button id="save-question-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition-colors duration-200 shadow-md">प्रश्न सेव करें</button>
            `;
        } else if (section === 'about-content' || section === 'privacy-content' || section === 'terms-content' || section === 'disclaimer-content') {
            html = `
                <h3 class="text-2xl font-bold mb-4">Edit ${section.replace('-content', '')}</h3>
                <textarea id="content-text" rows="10" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"></textarea>
                <button id="save-content-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors duration-200 shadow-md">सामग्री सेव करें</button>
            `;
        }
        contentDiv.innerHTML = html;

        if (section === 'add-question') {
            document.getElementById('save-question-btn').addEventListener('click', handleSaveQuestion);
        } else if (section.endsWith('-content')) {
            document.getElementById('save-content-btn').addEventListener('click', () => handleSaveContent(section));
            fetchContent(section);
        }
        const drawer = document.getElementById('drawer');
        if (drawer) drawer.classList.remove('open');
    }
    
    // नया फंक्शन: एडमिन कंटेंट को सेव करें
    async function handleSaveContent(section) {
        const content = document.getElementById('content-text').value;
        const contentRef = rtdb.ref(`appContent/${section.replace('-content', '')}`);
        try {
            await contentRef.set(content);
            showModal('सफलता', `सामग्री सफलतापूर्वक सेव की गई!`, [{ text: 'ठीक है', id: 'ok', class: 'bg-green-500 text-white' }]);
        } catch (error) {
            showModal('त्रुटि', `सामग्री सेव करने में विफल: ${error.message}`, [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white' }]);
        }
    }

    // नया फंक्शन: एडमिन कंटेंट को लाएँ
    async function fetchContent(section) {
        const contentRef = rtdb.ref(`appContent/${section.replace('-content', '')}`);
        try {
            const snapshot = await contentRef.once('value');
            const content = snapshot.val();
            const contentTextarea = document.getElementById('content-text');
            if (content && contentTextarea) {
                contentTextarea.value = content;
            }
        } catch (error) {
            console.error("कंटेंट लाने में त्रुटि:", error);
        }
    }

    // नया फंक्शन: यूज़र को कंटेंट दिखाएं
    async function showContentPage(title, defaultContent) {
        const contentDiv = document.getElementById('main-content');
        if (!contentDiv) return;

        const contentRef = rtdb.ref(`appContent/${title.replace(/ /g, '').toLowerCase()}`);
        let content = defaultContent;
        try {
            const snapshot = await contentRef.once('value');
            const fetchedContent = snapshot.val();
            if (fetchedContent) {
                content = fetchedContent;
            }
        } catch (error) {
            console.error("कंटेंट लाने में त्रुटि:", error);
        }

        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">${title}</h2>
                <div></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <p class="text-gray-700 whitespace-pre-wrap">${content}</p>
            </div>
        `;
        document.getElementById('drawer').classList.remove('open');
    }

    // --- एडमिन कार्यक्षमता ---
    async function handleSaveQuestion() {
        const subject = document.getElementById('subject-select').value;
        const testNumber = document.getElementById('test-select').value;
        const questionText = document.getElementById('question-text').value;
        const optionA = document.getElementById('option-A').value;
        const optionB = document.getElementById('option-B').value;
        const optionC = document.getElementById('option-C').value;
        const optionD = document.getElementById('option-D').value;
        const correctAnswer = document.querySelector('input[name="correct-answer"]:checked')?.value;

        if (!subject || !testNumber || !questionText || !optionA || !optionB || !optionC || !optionD || !correctAnswer) {
            showModal('Error', 'कृपया सभी फ़ील्ड भरें।', [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white' }]);
            return;
        }

        const questionData = {
            question: questionText,
            optionA: optionA,
            optionB: optionB,
            optionC: optionC,
            optionD: optionD,
            answer: correctAnswer
        };

        const dbRef = rtdb.ref(`quiz/${subject}/${testNumber}`);
        try {
            await dbRef.push(questionData);
            showModal('सफलता', 'प्रश्न सफलतापूर्वक सेव किया गया!', [{ text: 'ठीक है', id: 'ok', class: 'bg-green-500 text-white' }]);
            // फॉर्म साफ़ करें
            document.getElementById('question-text').value = '';
            document.getElementById('option-A').value = '';
            document.getElementById('option-B').value = '';
            document.getElementById('option-C').value = '';
            document.getElementById('option-D').value = '';
            const checkedRadio = document.querySelector('input[name="correct-answer"]:checked');
            if(checkedRadio) checkedRadio.checked = false;
        } catch (error) {
            showModal('त्रुटि', `प्रश्न को सेव करने में विफल: ${error.message}`, [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white' }]);
        }
    }
    
    // --- मुख्य पृष्ठ (उपयोगकर्ता) ---
    function renderMainPageContent() {
        const contentDiv = document.getElementById('main-content');
        if (!contentDiv) return;
        const subjects = [
            { name: "Hindi", emoji: "🇮🇳" }, { name: "Reasoning", emoji: "🧠" },
            { name: "Maths", emoji: "🧮" }, { name: "Current Affairs", emoji: "📰" },
            { name: "GK", emoji: "🌍" }, { name: "Science", emoji: "🔬" },
            { name: "Geography", emoji: "🗺️" }, { name: "Policy", emoji: "🏛️" },
            { name: "History", emoji: "📜" }, { name: "Previous Year", emoji: "📖" },
            { name: "Bihar GK", emoji: "🏰" }
        ];

        contentDiv.innerHTML = `
            <div class="grid subject-button-grid gap-4 max-w-4xl mx-auto">
                ${subjects.map(s => `
                    <button class="bg-white p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center space-y-2 transform transition-transform hover:scale-105" onclick="navigateToSubject('${s.name}')">
                        <span class="text-4xl">${s.emoji}</span>
                        <span class="font-semibold text-gray-800">${s.name}</span>
                    </button>
                `).join('')}
            </div>
        `;
    }
    
    // लॉगआउट संभालें
    function handleLogout() {
        auth.signOut().then(() => {
            navigateTo('login');
        }).catch(error => {
            showModal('लॉगआउट विफल', 'लॉगआउट के दौरान एक त्रुटि हुई।', [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white' }]);
        });
    }

    // --- विषय पृष्ठ ---
    function navigateToSubject(subjectName) {
        appState.activeSubject = subjectName;
        navigateTo('subject');
    }

    function renderSubjectPageContent() {
        const contentDiv = document.getElementById('main-content');
        if (!contentDiv) return;
        const completedTests = appState.userProgress[appState.activeSubject] || 0;
        const testButtons = Array.from({ length: 12 }, (_, i) => {
            const testNumber = i + 1;
            const isUnlocked = testNumber <= completedTests + 1;
            const isCompleted = testNumber <= completedTests;
            let statusText = '';
            let buttonClass = '';

            if (isCompleted) {
                statusText = 'पूरा हुआ';
                buttonClass = 'bg-green-500 hover:bg-green-600';
            } else if (isUnlocked) {
                statusText = 'अनलॉक';
                buttonClass = 'bg-blue-500 hover:bg-blue-600';
            } else {
                statusText = 'लॉक';
                buttonClass = 'bg-gray-400 cursor-not-allowed';
            }
            
            return `
                <button class="w-full py-4 rounded-lg text-white font-bold shadow-md transition-transform transform hover:scale-105 ${buttonClass}" 
                        ${isUnlocked ? `onclick="startTest(${testNumber})"` : 'disabled'}>
                    टेस्ट ${testNumber}
                    <span class="block text-xs font-normal mt-1">${statusText}</span>
                </button>
            `;
        }).join('');

        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">${appState.activeSubject} टेस्ट</h2>
                <div></div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
                ${testButtons}
            </div>
        `;
    }

    // --- क्विज तर्क ---
    async function startTest(testNumber) {
        appState.activeTestNumber = testNumber;
        appState.currentQuestionIndex = 0;
        appState.userAnswers = {};

        // मौजूदा प्रगति के लिए जांच करें
        const storedProgress = await fetchQuizProgress();

        if (storedProgress && Object.keys(storedProgress.userAnswers).length > 0) {
            showModal(
                'टेस्ट फिर से शुरू करें',
                'क्या आप टेस्ट वहीं से जारी रखना चाहेंगे जहाँ आपने छोड़ा था या शुरू से शुरू करना चाहेंगे?',
                [
                    { text: 'जारी रखें', id: 'continue', class: 'bg-blue-500 text-white', action: () => {
                        appState.userAnswers = storedProgress.userAnswers;
                        appState.currentQuestionIndex = storedProgress.currentQuestionIndex;
                        fetchQuestions();
                    }},
                    { text: 'पुनः शुरू करें', id: 'restart', class: 'bg-red-500 text-white', action: () => {
                        fetchQuestions();
                    }}
                ]
            );
        } else {
            fetchQuestions();
        }
    }

    async function fetchQuestions() {
        const contentDiv = document.getElementById('main-content');
        if (!contentDiv) return;
        const loadingHtml = `<div class="flex items-center justify-center min-h-screen"><i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i></div>`;
        contentDiv.innerHTML = loadingHtml;

        const subject = appState.activeSubject;
        const testNumber = appState.activeTestNumber;
        
        try {
            const dbRef = rtdb.ref(`quiz/${subject}/test${testNumber}`);
            const snapshot = await dbRef.once('value');
            const questionsObject = snapshot.val();
            if (questionsObject) {
                appState.questions = Object.values(questionsObject).slice(0, 20); // पहले 20 प्रश्न प्राप्त करें
                navigateTo('quiz');
            } else {
                showModal('त्रुटि', 'इस टेस्ट के लिए कोई प्रश्न नहीं मिला। कृपया दूसरा प्रयास करें।', [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white', action: () => navigateTo('subject') }]);
            }
        } catch (error) {
            console.error("प्रश्नों को लाने में त्रुटि:", error);
            showModal('त्रुटि', 'क्विज लोड करने में विफल। कृपया अपना नेटवर्क जांचें और पुनः प्रयास करें।', [{ text: 'ठीक है', id: 'ok', class: 'bg-red-500 text-white', action: () => navigateTo('subject') }]);
        }
    }

    function renderQuizPageContent() {
        const contentDiv = document.getElementById('main-content');
        if (!contentDiv) return;
        const question = appState.questions[appState.currentQuestionIndex];
        if (!question) {
            return navigateTo('results');
        }

        const options = ['A', 'B', 'C', 'D'].map(key => ({
            key,
            text: question[`option${key}`]
        }));
        
        const currentAnswer = appState.userAnswers[appState.currentQuestionIndex];

        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">क्विज</h2>
                <div class="text-lg">प्र. ${appState.currentQuestionIndex + 1}/${appState.questions.length}</div>
            </div>
            <div class="container mx-auto p-4 max-w-2xl w-full">
                <div class="bg-white p-6 rounded-lg shadow-lg mb-4">
                    <p class="text-lg font-semibold text-gray-800">${question.question}</p>
                </div>
                <div class="space-y-4">
                    ${options.map(opt => `
                        <button id="option-${opt.key}" class="w-full text-left p-4 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105
                            ${currentAnswer === opt.key ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}
                        " onclick="handleAnswer('${opt.key}')">
                            <span class="font-bold mr-2">${opt.key}.</span> ${opt.text}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function handleBackDuringQuiz() {
        showModal(
            'क्विज से बाहर निकलें?',
            'आपकी प्रगति सेव की जाएगी। क्या आप टेस्ट से बाहर निकलना चाहते हैं?',
            [
                { text: 'हाँ', id: 'yes', class: 'bg-red-500 text-white', action: () => {
                    saveQuizProgress();
                    navigateTo('subject');
                }},
                { text: 'नहीं', id: 'no', class: 'bg-blue-500 text-white', action: () => {} }
            ]
        );
    }

    async function handleAnswer(answer) {
        appState.userAnswers[appState.currentQuestionIndex] = answer;
        await saveQuizProgress(); // प्रत्येक उत्तर के बाद प्रगति सेव करें
        setTimeout(() => {
            appState.currentQuestionIndex++;
            renderQuizPageContent();
        }, 500); // दृश्य प्रतिक्रिया के लिए थोड़ी देरी
    }

    // --- परिणाम पृष्ठ ---
    function renderResultsPageContent() {
        const contentDiv = document.getElementById('main-content');
        if (!contentDiv) return;
        let correctCount = 0;
        let incorrectCount = 0;
        appState.questions.forEach((q, index) => {
            const userAnswer = appState.userAnswers[index];
            if (userAnswer && userAnswer === q.answer) {
                correctCount++;
            } else if (userAnswer) {
                incorrectCount++;
            }
        });

        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">टेस्ट परिणाम</h2>
                <div></div>
            </div>
            <div class="container mx-auto p-4 max-w-2xl w-full">
               <div class="bg-white p-6 rounded-lg shadow-lg text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">क्विज पूरा हुआ!</h2>
                    <p class="text-xl font-semibold text-gray-700">आपका स्कोर:</p>
                    <p class="text-5xl font-extrabold text-blue-600 my-4">${correctCount}/${appState.questions.length}</p>
                    <div class="flex justify-around text-center">
                        <div>
                            <p class="text-green-600 font-bold text-xl">${correctCount}</p>
                            <p class="text-gray-600">सही</p>
                        </div>
                        <div>
                            <p class="text-red-600 font-bold text-xl">${incorrectCount}</p>
                            <p class="text-gray-600">गलत</p>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col space-y-4">
                    <button class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors duration-200 shadow-lg" onclick="viewAllQuestions()">सभी प्रश्न देखें</button>
                    <button class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors duration-200 shadow-lg" onclick="reAttemptTest()">पुनः प्रयास करें</button>
                </div>
            </div>
        `;
        
        updateUserProgress(appState.activeSubject, appState.activeTestNumber);
    }
    
    // परिणाम पृष्ठ क्रियाएँ
    function viewAllQuestions() {
        const contentDiv = document.getElementById('main-content');
        if (!contentDiv) return;
        const questionsHtml = appState.questions.map((q, index) => {
            const userAnswer = appState.userAnswers[index];
            const isCorrect = userAnswer === q.answer;
            const userStatus = isCorrect ? 'सही' : 'गलत';
            const statusClass = isCorrect ? 'text-green-600' : 'text-red-600';

            return `
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <p class="font-semibold text-gray-800">प्र. ${index + 1}: ${q.question}</p>
                    <ul class="list-disc list-inside mt-2 text-gray-700">
                        <li>A. ${q.optionA}</li>
                        <li>B. ${q.optionB}</li>
                        <li>C. ${q.optionC}</li>
                        <li>D. ${q.optionD}</li>
                    </ul>
                    <p class="mt-2 text-sm">
                        <span class="font-bold">आपका उत्तर:</span> <span class="${statusClass}">${userAnswer || 'कोई उत्तर नहीं'} (${userStatus})</span>
                    </p>
                    <p class="mt-1 text-sm font-bold text-blue-600">सही उत्तर: ${q.answer}</p>
                </div>
            `;
        }).join('');

        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">सभी प्रश्न</h2>
                <div></div>
            </div>
            <div class="container mx-auto p-4">
                ${questionsHtml}
            </div>
        `;
    }

    function reAttemptTest() {
        navigateTo('quiz', { currentQuestionIndex: 0, userAnswers: {} });
    }

    // --- बैक बटन और शेयर तर्क ---
    window.onpopstate = () => {
        // इतिहास-आधारित नेविगेशन को आवश्यकतानुसार लागू करें
    };

    function shareApp() {
        // Share API not available in all contexts, provide a fallback.
        if (navigator.share) {
            navigator.share({
                title: 'GD ExamCracker',
                text: 'GD एग्जाम की तैयारी करें GD ExamCracker के साथ!',
                url: window.location.href,
            }).then(() => {
                console.log('शेयर करने के लिए धन्यवाद!');
            }).catch(console.error);
        } else {
            showModal('ऐप शेयर करें', 'शेयर करने के लिए कृपया इस लिंक को कॉपी करें: ' + window.location.href, [{ text: 'ठीक है', id: 'ok', class: 'bg-blue-500 text-white' }]);
        }
    }

    // प्रारंभिक रेंडर
    window.onload = () => {
        renderApp();
    };

</script>
</body>
</html>
